

<!DOCTYPE html>
<html lang="ko">
<h2>🌡️ 나의 웹 (2567029 임지우)</h2>
  <div id="status">MQTT 연결 중...</div>

  <div class="data-box">
    <div class="label">온도 (°C)</div>
    <div class="value" id="temp">--</div>
  </div>
  <div class="data-box">
    <div class="label">습도 (%)</div>
    <div class="value" id="hum">--</div>
  </div>

  <div id="log" style="margin-top:20px;"></div>

  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const topic = 'ewha/2567029';
    const clientId = 'webclient-' + Math.random().toString(16).substr(2, 8);

    const client = mqtt.connect(brokerUrl, { clientId });

    const statusDiv = document.getElementById("status");
    const tDiv = document.getElementById("temp");
    const hDiv = document.getElementById("hum");
    const logDiv = document.getElementById("log");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    client.on('connect', () => {
      statusDiv.textContent = "✅ MQTT 연결 성공!";
      client.subscribe(topic, (err) => {
        log(`토픽 구독 완료: ${topic}`);
      });
      client.publish("ewha/2567029", "2567029 임지우 웹페이지 접속");
    });

    client.on('message', (topic, message) => {
      log(`메시지 수신: ${message}`);
      try {
        const data = JSON.parse(message);
        if (data.temperature !== undefined) tDiv.textContent = data.temperature.toFixed(1);
        if (data.humidity !== undefined) hDiv.textContent = data.humidity.toFixed(1);
      } catch (e) {
        log("⚠️ JSON 파싱 오류: " + e);
      }
    });

    client.on('error', (err) => {
      statusDiv.textContent = "❌ 브로커 연결 오류";
      log("연결 에러: " + err.message);
    });
  </script>
</body>
</html>
