<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ESP32 ì˜¨ìŠµë„ ëª¨ë‹ˆí„°ë§ (2567029 ì„ì§€ìš°)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 50px; background-color: #f6f8fa; }
    .data-box { display: inline-block; background: #fff; border: 1px solid #ccc; border-radius: 10px; padding: 20px 40px; margin: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
    .label { font-size: 1.2em; color: #444; }
    .value { font-size: 2.5em; font-weight: bold; color: #0070c9; }
    #status { margin-bottom: 20px; font-weight: bold; color: #00796b; }
  </style>
</head>
<body>
  <h2>ğŸŒ¡ï¸ ë‚˜ì˜ ì›¹ (2567029 ì„ì§€ìš°)</h2>
  <div id="status">MQTT ì—°ê²° ì¤‘...</div>

  <div class="data-box">
    <div class="label">ì˜¨ë„ (Â°C)</div>
    <div class="value" id="temp">--</div>
  </div>
  <div class="data-box">
    <div class="label">ìŠµë„ (%)</div>
    <div class="value" id="hum">--</div>
  </div>

  <div id="log" style="margin-top:20px;"></div>

  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const topic = 'ewha/0317137263';
    const clientId = 'webclient-' + Math.random().toString(16).substr(2, 8);

    const client = mqtt.connect(brokerUrl, { clientId });

    const statusDiv = document.getElementById("status");
    const tDiv = document.getElementById("temp");
    const hDiv = document.getElementById("hum");
    const logDiv = document.getElementById("log");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    client.on('connect', () => {
      statusDiv.textContent = "âœ… MQTT ì—°ê²° ì„±ê³µ!";
      client.subscribe(topic, (err) => {
        log(`í† í”½ êµ¬ë… ì™„ë£Œ: ${topic}`);
      });
      client.publish("ewha/checkin", "2567029 ì„ì§€ìš° ì›¹í˜ì´ì§€ ì ‘ì†");
    });

    client.on('message', (topic, message) => {
      log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${message}`);
      try {
        const data = JSON.parse(message);
        if (data.temperature !== undefined) tDiv.textContent = data.temperature.toFixed(1);
        if (data.humidity !== undefined) hDiv.textContent = data.humidity.toFixed(1);
      } catch (e) {
        log("âš ï¸ JSON íŒŒì‹± ì˜¤ë¥˜: " + e);
      }
    });

    client.on('error', (err) => {
      statusDiv.textContent = "âŒ ë¸Œë¡œì»¤ ì—°ê²° ì˜¤ë¥˜";
      log("ì—°ê²° ì—ëŸ¬: " + err.message);
    });
  </script>
</body>
</html>
